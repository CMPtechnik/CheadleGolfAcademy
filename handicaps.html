<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Junior Handicaps</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .modal-lg {
      max-width: 90% !important;
    }
    canvas {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4">Junior Handicaps</h1>
    <div class="table-responsive">
      <table class="table table-bordered" id="playerTable">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Rounds Played</th>
            <th>Handicap</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="explanation" class="mt-5">
      <h5>How Handicaps Are Calculated</h5>
      <p>
        Handicaps are calculated using the player's gross score minus the par for the round, multiplied by 0.93.
        For example, if a player scores 45 on a par 32 course: (45 - 32) Ã— 0.93 = 12.1 handicap.
      </p>
      <p>
        The system supports two different par values depending on the competition type:
        <ul>
          <li><strong>Junior Competition</strong> (9 holes): Par 32</li>
          <li><strong>Junior Competition Sixes</strong>: Par 22</li>
        </ul>
        The final handicap is an average of all rounds played by the player.
      </p>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="playerModalLabel">Player Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6 id="playerName"></h6>
          <canvas id="handicapChart"></canvas>
          <table class="table mt-4">
            <thead>
              <tr>
                <th>Date</th>
                <th>Score</th>
                <th>Competition</th>
                <th>Handicap</th>
              </tr>
            </thead>
            <tbody id="playerScores"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    async function fetchData() {
      const res = await fetch("https://raw.githubusercontent.com/CMPtechnik/cheadlegolfacademy/main/data/leaguedata.xlsx");
      const arrayBuffer = await res.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      return XLSX.utils.sheet_to_json(worksheet);
    }

    function getParForCompetition(name) {
      if (!name) return 32;
      name = name.toLowerCase();
      if (name.includes('sixes')) return 22;
      if (name.includes('junior competition')) return 32;
      return 32;
    }

    function groupByPlayer(data) {
      const map = new Map();
      data.forEach(row => {
        const name = row.Name?.trim();
        if (!name) return;
        if (!map.has(name)) map.set(name, []);
        map.get(name).push(row);
      });
      return map;
    }

    function calculateAverage(arr) {
      const valid = arr.filter(v => !isNaN(v));
      if (valid.length === 0) return null;
      const sum = valid.reduce((a, b) => a + b, 0);
      return (sum / valid.length).toFixed(1);
    }

    function updateLeague(data) {
      const grouped = groupByPlayer(data);
      const tbody = document.querySelector("#playerTable tbody");
      tbody.innerHTML = "";

      grouped.forEach((rounds, player) => {
        const handicaps = rounds.map(r => {
          const roundPar = getParForCompetition(r.Competition);
          return (parseFloat(r.Score) - roundPar) * 0.93;
        });
        const avgHandicap = calculateAverage(handicaps);

        const row = document.createElement("tr");
        row.innerHTML = `<td><a href="#" class="player-link" data-player="${player}">${player}</a></td>
                         <td>${rounds.length}</td>
                         <td>${avgHandicap}</td>`;
        tbody.appendChild(row);
      });

      document.querySelectorAll(".player-link").forEach(link => {
        link.addEventListener("click", e => {
          e.preventDefault();
          const playerName = e.target.getAttribute("data-player");
          showPlayerModal(playerName, grouped.get(playerName));
        });
      });
    }

    function showPlayerModal(playerName, scores) {
      document.getElementById("playerName").textContent = playerName;

      const tbody = document.getElementById("playerScores");
      tbody.innerHTML = "";

      const handicapData = scores.map(s => {
        const roundPar = getParForCompetition(s.Competition);
        const h = parseFloat(((s.Score - roundPar) * 0.93).toFixed(1));
        const date = s.Date || "";
        tbody.innerHTML += `<tr><td>${date}</td><td>${s.Score}</td><td>${s.Competition}</td><td>${h}</td></tr>`;
        return { x: date, y: h };
      });

      const chartCanvas = document.getElementById("handicapChart");
      if (window.handicapChart) window.handicapChart.destroy();

      window.handicapChart = new Chart(chartCanvas, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Handicap Over Time',
            data: handicapData,
            borderColor: 'blue',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          scales: {
            x: { type: 'category', title: { display: true, text: 'Date' } },
            y: { beginAtZero: false, title: { display: true, text: 'Handicap' } }
          }
        }
      });

      const modal = new bootstrap.Modal(document.getElementById("playerModal"));
      modal.show();
    }

    fetchData().then(updateLeague);
  </script>
</body>
</html>
