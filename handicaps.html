<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cheadle Juniors Leaderboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f8f8f8; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 10% auto; padding: 20px; width: 80%; }
    .close { float: right; cursor: pointer; font-size: 24px; }
    .tab-btns button { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Cheadle Juniors Leaderboard</h1>

  <table id="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Games</th>
        <th>Net Win %</th>
        <th>Total Points</th>
        <th>HCP</th>
        <th>Trophies</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="playerModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalName"></h2>
      <div class="tab-btns">
        <button onclick="showTab('history')">Round History</button>
        <button onclick="showTab('chart')">Leaderboard Position</button>
        <button onclick="showTab('hcp')">Handicap</button>
      </div>
      <div id="tabContent"></div>
      <canvas id="positionChart" height="200" style="display:none;"></canvas>
      <canvas id="handicapChart" height="200" style="display:none;"></canvas>
    </div>
  </div>

  <script>
    const rawData = [];
    const parMap = {
      "Junior Competition": 32,
      "Junior Competition Sixes": 22
    };

    async function fetchData() {
      const response = await fetch('data.json'); // Replace with your source
      const data = await response.json();
      rawData.push(...data);
      updateLeague();
    }

    function updateLeague() {
      const netScores = {};
      const netWins = {};
      const totalPoints = {};

      rawData.forEach(entry => {
        const { name, net, points } = entry;
        if (!netScores[name]) netScores[name] = [];
        netScores[name].push(net);

        if (!totalPoints[name]) totalPoints[name] = 0;
        totalPoints[name] += points;
      });

      rawData.forEach(entry => {
        const { name } = entry;
        if (!netWins[name]) netWins[name] = 0;
        if (entry.result === 'win') netWins[name]++;
      });

      const players = Object.keys(netScores).map(name => {
        const playerScores = rawData.filter(s => s.name === name);
        const games = playerScores.length;
        const wins = netWins[name] || 0;
        const winPct = ((wins / games) * 100).toFixed(1);

        const handicaps = playerScores.map(s => {
          const par = parMap[s.title] || 32;
          return (s.score - par) * 0.93;
        });

        const avgHcp = (handicaps.reduce((a, b) => a + b, 0) / handicaps.length).toFixed(1);

        return {
          name,
          games,
          winPct,
          points: totalPoints[name],
          trophies: wins,
          handicap: isNaN(avgHcp) ? '-' : avgHcp
        };
      });

      players.sort((a, b) => b.points - a.points);

      const tbody = document.querySelector('#leaderboard tbody');
      tbody.innerHTML = '';
      players.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td><a href="#" onclick="showPlayerModal('${p.name}')">${p.name}</a></td>
          <td>${p.games}</td>
          <td>${p.winPct}%</td>
          <td>${p.points}</td>
          <td>${p.handicap}</td>
          <td>${p.trophies}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showPlayerModal(name) {
      const scores = rawData.filter(s => s.name === name);
      document.getElementById('modalName').textContent = name;
      showTab('history');

      const labels = scores.map(s => s.date);
      const posData = scores.map(s => s.position || null);

      const handicapData = scores.map(s => {
        const par = parMap[s.title] || 32;
        const hcp = ((s.score - par) * 0.93).toFixed(1);
        return isNaN(hcp) ? null : parseFloat(hcp);
      });

      const ctx = document.getElementById('positionChart').getContext('2d');
      if (window.positionChart instanceof Chart) window.positionChart.destroy();
      window.positionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{ label: 'Leaderboard Position', data: posData, borderColor: 'blue', fill: false }]
        },
        options: { responsive: true, scales: { y: { reverse: true } } }
      });

      const ctxHcp = document.getElementById('handicapChart').getContext('2d');
      if (window.handicapChart instanceof Chart) window.handicapChart.destroy();
      window.handicapChart = new Chart(ctxHcp, {
        type: 'line',
        data: {
          labels,
          datasets: [{ label: 'Handicap Over Time', data: handicapData, borderColor: 'orange', fill: false }]
        },
        options: { responsive: true, scales: { y: { title: { display: true, text: 'Handicap' }, reverse: true } } }
      });

      const historyHTML = `
        <table>
          <thead>
            <tr><th>Date</th><th>Competition</th><th>Gross</th><th>Net</th><th>Par</th><th>Points</th></tr>
          </thead>
          <tbody>
            ${scores.map(s => {
              const par = parMap[s.title] || 32;
              return `<tr><td>${s.date}</td><td>${s.title}</td><td>${s.score}</td><td>${s.net}</td><td>${par}</td><td>${s.points}</td></tr>`;
            }).join('')}
          </tbody>
        </table>`;

      document.getElementById('tabContent').innerHTML = historyHTML;
      document.getElementById('playerModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('playerModal').style.display = 'none';
    }

    function showTab(tab) {
      document.getElementById('positionChart').style.display = tab === 'chart' ? 'block' : 'none';
      document.getElementById('handicapChart').style.display = tab === 'hcp' ? 'block' : 'none';
      document.getElementById('tabContent').style.display = tab === 'history' ? 'block' : 'none';
    }

    fetchData();
  </script>
</body>
</html>
