<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Junior Handicaps ‚Äì Cheadle Golf Academy</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    body { padding: 20px; }
    table { width: 100%; }
    dialog::backdrop { background: rgba(0,0,0,0.5); }
    .modal-content { padding: 20px; max-width: 800px; width: 95%; }
    .best-round { background-color: #ffeaa7; font-weight: bold; }
    .sortable:hover { cursor: pointer; text-decoration: underline; }
    @media screen and (max-width: 768px) {
      .modal-content { width: 95%; padding: 10px; }
    }
  </style>
</head>
<body>
  <section class="section">
    <div class="container">
    <center><h1 class="title">Junior Handicap Tracker</h1></center>
    <center><p class="mb-4">Click on a player‚Äôs <strong>View</strong> button to see per-round details and chart.</p></center>
    <br><center>‚¨ÖÔ∏è‚û°Ô∏è Scroll to view full table on mobile</center>
<b><center>This is a Cheadle Golf Club Junior Section / Junior Academy Handicap used as a leveler and a progress tracker. It is <u>not</u> related to any WHS calculations</center></b>
      <table class="table is-striped is-fullwidth" id="handicapTable">
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Player ‚¨ç</th>
            <th class="sortable" data-sort="current">Current Handicap ‚¨ç</th>
            <th class="sortable" data-sort="lowest">Lowest Handicap ‚¨ç</th>
            <th class="sortable" data-sort="roundsPlayed">Rounds Played ‚¨ç</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <h2 class="title is-5 mt-6">How are handicaps calculated?</h2>
      <div class="content box" style="background:#f5f5f5;">
        <p>
          Handicaps are based on the average of a player's <strong>best 3 gross scores</strong>, relative to par, from recent rounds.
          <br />
          <strong>Formula:</strong> <code>(Gross Score ‚àí Par) √ó 0.93</code>
        </p>
        <ul>
          <li>üèåÔ∏è‚Äç‚ôÇÔ∏è <strong>Junior Competition</strong>: Par 32</li>
          <li>üèåÔ∏è <strong>Junior Sixes Competition</strong>: Par 22</li>
          <li>‚õ≥ <strong>Bruntwood 9</strong>: Par 27</li>
          <li>‚õ≥ <strong>Bruntwood 18</strong>: Par 54</li>
        </ul>
        <p>
          Handicaps are shown to 1 decimal place and updated after each new round. The best 3 scores are used to calculate the current handicap.
        </p>
        <p>
          <b>This is a Cheadle Golf Club Junior Section / Junior Academy Handicap used as a leveler and a progress tracker. It is <u>not</u> related to any WHS calculations</b>
        </p>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <dialog id="modal">
    <div class="modal-content box">
      <button class="delete is-pulled-right" id="closeModal"></button>
      <h2 class="title is-4" id="modalPlayerName"></h2>
      <div id="modalContent" class="mb-4"></div>
      <canvas id="handicapChart" height="200"></canvas>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ‚úÖ FIXED DATE PARSER (handles Excel serials + text)
    function parseDateStr(s) {
      if (!s) return new Date('Invalid');
      // Excel serial (e.g. 45789)
      if (!isNaN(s) && Number(s) > 20000 && Number(s) < 80000) {
        return new Date((Number(s) - 25569) * 86400 * 1000);
      }
      // dd/mm/yyyy or d/m/yyyy text
      if (typeof s === 'string' && s.includes('/')) {
        const [d, m, y] = s.split(/[\/\-]/).map(v => parseInt(v));
        return new Date(y, m - 1, d);
      }
      // fallback
      const d = new Date(s);
      return isNaN(d.getTime()) ? new Date('Invalid') : d;
    }

    const getParForCompetition = (name) => {
      if (!name) return 32;
      if (name.includes("Sixes")) return 22;
      if (name.includes("Bruntwood 9")) return 27;
      if (name.includes("Bruntwood 18")) return 54;
      return 32;
    };

    async function fetchData() {
      const res = await fetch("https://raw.githubusercontent.com/CMPtechnik/cheadlegolfacademy/main/data/leaguedata.xlsx?v=" + Date.now());
      const ab = await res.arrayBuffer();
      const wb = XLSX.read(ab, { type: "array" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(sheet);

      const players = {};
      data.forEach(row => {
        const name = row.Name;
        const score = parseFloat(row.Score);
        const comp = row.Competition;
        const date = row.Date;
        if (!name || isNaN(score)) return;
        if (!players[name]) players[name] = [];
        players[name].push({ score, competition: comp, date });
      });

      const playerStats = Object.keys(players).map(name => {
        const rounds = players[name];
        const handicaps = rounds.map(r => (r.score - getParForCompetition(r.competition)) * 0.93);
        const best3 = [...handicaps].sort((a, b) => a - b).slice(0, 3);
        const current = (best3.reduce((a, b) => a + b, 0) / best3.length).toFixed(1);
        const lowest = Math.min(...handicaps).toFixed(1);
        return { name, current: parseFloat(current), lowest: parseFloat(lowest), roundsPlayed: rounds.length, rounds };
      });

      renderTable(playerStats);
    }

    function renderTable(players) {
      const tableBody = document.querySelector("#handicapTable tbody");
      tableBody.innerHTML = "";

      players.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.current.toFixed(1)}</td>
          <td>${p.lowest.toFixed(1)}</td>
          <td>${p.roundsPlayed}</td>
          <td><button class="button is-small is-info open-modal" data-name="${p.name}">View</button></td>
        `;
        tableBody.appendChild(tr);
      });

      document.querySelectorAll(".open-modal").forEach(btn => {
        btn.addEventListener("click", e => {
          const name = e.target.dataset.name;
          const player = players.find(p => p.name === name);
          openModal(name, player.rounds);
        });
      });

      // Sorting
      document.querySelectorAll(".sortable").forEach(th => {
        if (th.asc === undefined) th.asc = true;
        th.addEventListener("click", () => {
          const key = th.dataset.sort;
          const asc = th.asc;
          th.asc = !asc;

          players.sort((a, b) => {
            if (key === 'name') {
              return asc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
            } else {
              return asc ? a[key] - b[key] : b[key] - a[key];
            }
          });
          renderTable(players);
        });
      });
    }

    function openModal(name, rounds) {
      const modal = document.getElementById("modal");
      document.getElementById("modalPlayerName").textContent = name;

      const handicaps = rounds.map(r => ({
        ...r,
        hcap: ((r.score - getParForCompetition(r.competition)) * 0.93).toFixed(1)
      }));
      const best3Hcap = [...handicaps].sort((a, b) => a.hcap - b.hcap).slice(0, 3).map(r => r.hcap);

      const content = document.getElementById("modalContent");
      content.innerHTML = `
        <table class="table is-fullwidth is-narrow">
          <thead>
            <tr>
              <th>Date</th><th>Competition</th><th>Score</th><th>Par</th><th>Handicap</th>
            </tr>
          </thead>
          <tbody>
            ${handicaps.map(r => {
              const d = parseDateStr(r.date);
              const dateStr = !isNaN(d.getTime()) ? d.toLocaleDateString("en-GB") : '';
              return `
                <tr class="${best3Hcap.includes(r.hcap) ? 'best-round' : ''}">
                  <td>${dateStr}</td>
                  <td>${r.competition} ${best3Hcap.includes(r.hcap) ? 'üèÜ' : ''}</td>
                  <td>${r.score}</td>
                  <td>${getParForCompetition(r.competition)}</td>
                  <td>${r.hcap}</td>
                </tr>`;
            }).join("")}
          </tbody>
        </table>
      `;

      // Chart setup
      const chartLabels = rounds.map(r => {
        const d = parseDateStr(r.date);
        return !isNaN(d.getTime()) ? d.toLocaleDateString("en-GB") : '';
      });
      const chartData = handicaps.map(r => parseFloat(r.hcap));

      const ctx = document.getElementById("handicapChart").getContext("2d");
      if (window.hcapChart) window.hcapChart.destroy();
      window.hcapChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Handicap per Round',
            data: chartData,
            borderColor: '#3273dc',
            backgroundColor: chartData.map(h => best3Hcap.includes(h.toFixed(1)) ? '#f6e58d99' : '#3273dc33'),
            fill: true,
            tension: 0.3
          }]
        },
        options: { scales: { y: { beginAtZero: false, reverse: true } } }
      });

      modal.showModal();
    }

    document.getElementById("closeModal").addEventListener("click", () => {
      document.getElementById("modal").close();
    });

    fetchData();
  </script>

</body>
</html>
