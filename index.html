<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cheadle Juniors</title>

  <!-- Favicon & Apple Icons -->
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="favicon.png" sizes="180x180">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Cheadle Juniors">
  <meta name="theme-color" content="#00c896" />

  <!-- Chart.js & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* =========================================================
       MODERN TEEN-FRIENDLY UI REFRESH (FUNCTIONALITY UNCHANGED)
       ========================================================= */

    :root {
      --primary: #00c896;
      --primary-dark: #008f6a;
      --accent: #eafff8;
      --text: #0f172a;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: rgba(0,0,0,0.08);
      --hover: rgba(0,0,0,0.04);
      --radius: 14px;

      --shadow-1: 0 10px 25px rgba(0,0,0,0.08);
      --shadow-2: 0 20px 40px rgba(0,0,0,0.10);
      --shadow-3: 0 30px 80px rgba(0,0,0,0.25);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
      margin: 0;
      background:
        radial-gradient(1200px 600px at 10% -10%, #d1fae5, transparent),
        radial-gradient(800px 400px at 90% 10%, #ccfbf1, transparent),
        var(--bg);
      color: var(--text);
      transition: background 0.25s ease, color 0.25s ease;
    }

    .dark-mode {
      --bg: #020617;
      --text: #e5e7eb;
      --card: #0b1220;
      --accent: rgba(15,118,110,0.25);
      --border: rgba(255,255,255,0.12);
      --hover: rgba(255,255,255,0.06);

      --shadow-1: 0 10px 25px rgba(0,0,0,0.35);
      --shadow-2: 0 20px 40px rgba(0,0,0,0.45);
      --shadow-3: 0 30px 80px rgba(0,0,0,0.60);
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1.5rem 1rem 2rem;
      text-align: center;
      position: relative;
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    header::after {
      content: "";
      position: absolute;
      inset: -120px -120px auto auto;
      width: 280px;
      height: 280px;
      background: rgba(255,255,255,0.20);
      filter: blur(0px);
      border-radius: 999px;
      transform: rotate(15deg);
      pointer-events: none;
    }

    header img {
      max-height: 220px;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.28));
    }
    header {
      padding-bottom: 2.75rem; /* creates space for buttons */
    }
    #darkModeToggle {
      position: absolute;
      top: 14px;
      right: 16px;
      cursor: pointer;
      font-size: 1.6rem;
      user-select: none;
      opacity: 0.95;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }

    #darkModeToggle:hover {
      transform: scale(1.06);
      opacity: 1;
    }

    /* Nav tiles */
    .info-links {
    position: relative;
    z-index: 5;

    margin: 0.75rem auto 1rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.75rem;

    max-width: 980px;
    padding: 0 1rem;
  }

    .info-btn {
      background: var(--card);
      color: var(--text);
      padding: 0.95rem 1rem;
      border-radius: var(--radius);
      text-decoration: none;
      font-weight: 900;
      letter-spacing: 0.01em;
      box-shadow: var(--shadow-1);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border: 1px solid var(--border);
    }

    .info-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-2);
    }

    /* helper notices */
    .hint {
      text-align: center;
      margin: 1rem auto 0.5rem;
      opacity: 0.85;
      font-weight: 700;
    }

    main {
      max-width: 1100px;
      margin: auto;
      padding: 1rem;
    }

    /* Season selector card */
    .season-card {
      margin: 1rem auto;
      max-width: 980px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-1);
      border-radius: var(--radius);
      padding: 0.9rem 1rem;
      display: flex;
      gap: 0.8rem;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .season-card label {
      font-weight: 900;
      letter-spacing: 0.02em;
    }

    select {
      padding: 0.65rem 1rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-weight: 800;
      outline: none;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card);
      box-shadow: var(--shadow-2);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    th, td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--accent);
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 900;
    }

    tbody tr {
      transition: background 0.15s ease, transform 0.15s ease;
    }

    tbody tr:nth-child(even) {
      background: rgba(0,0,0,0.015);
    }

    .dark-mode tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.03);
    }

    tbody tr:hover {
      background: var(--hover);
      transform: scale(1.01);
    }

    a {
      color: var(--primary-dark);
      text-decoration: none;
      font-weight: 900;
    }

    /* Trophy tooltip */
    .trophy {
      position: relative;
      display: inline-block;
      cursor: pointer;
      user-select: none;
    }

    .tooltip-bubble {
      display: none;
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.92);
      color: white;
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 0.78rem;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: 0 12px 22px rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.15);
    }

    .trophy.show-tooltip .tooltip-bubble {
      display: block;
    }

    /* Next comp card */
    #nextCompetition {
      text-align: center;
      padding: 1rem;
      font-size: 1rem;
      background: var(--card);
      margin: 1rem auto 0.75rem;
      max-width: 980px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-1);
      border: 1px solid var(--border);
    }

    #weatherDetails {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal-content {
      background: var(--card);
      color: var(--text);
      padding: 1.25rem 1.25rem 1rem;
      border-radius: 20px;
      max-width: 650px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-3);
      border: 1px solid var(--border);
      animation: pop 0.22s ease-out;
    }

    @keyframes pop {
      from { transform: scale(0.97); opacity: 0 }
      to { transform: scale(1); opacity: 1 }
    }

    .close-btn {
      float: right;
      font-size: 22px;
      cursor: pointer;
      user-select: none;
      opacity: 0.8;
      transition: opacity 0.15s ease;
    }

    .close-btn:hover { opacity: 1; }

    .tabs {
      text-align: center;
      margin: 1rem 0 0.75rem;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.45rem;
    }

    .tabs button {
      padding: 0.55rem 1.15rem;
      border: none;
      border-radius: 999px;
      background: rgba(99,102,241,0.14);
      color: var(--text);
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease;
    }

    .tabs button:hover { transform: translateY(-1px); }

    .tabs button.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    #scoreChart, #positionChart {
      margin-bottom: 0.75rem;
      background: rgba(0,0,0,0.00);
    }

    ul { padding-left: 1.2rem; }
    li { margin: 0.2rem 0; }

    /* Info bar */
    .info-bar {
      background: var(--card);
      max-width: 980px;
      margin: 0.75rem auto 0.25rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-1);
      padding: 0.6rem 0.9rem;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 800;
    }

    .info-bar h4 { margin: 0; font-weight: 900; }

    /* Footer */
    .footer {
      text-align: center;
      padding: 1rem 0 1.5rem;
      opacity: 0.92;
    }

    .footer img { vertical-align: middle; }

    /* Mobile */
    @media screen and (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      header img { max-height: 180px; }
    }
  </style>
</head>

<body>
  <header>
    <img src="logowhite.png" alt="League Logo" />
    <span id="darkModeToggle" onclick="toggleDarkMode()">üåó</span>
  </header>

  <div class="info-links">
    <a href="results.html" class="info-btn">üìä Results</a>
    <a href="calendar.html" class="info-btn">üìÖ Calendar</a>
    <a href="seriesresults.html" class="info-btn">üìà Series Tables</a>
    <a href="handicaps.html" class="info-btn">üèåÔ∏è CGC Handicaps</a>
  </div>

  <div class="hint">‚¨ÖÔ∏è‚û°Ô∏è Scroll to view full table</div>
  <div class="hint">Tap a player name to view stats</div>

  <main>
    <div class="season-card">
      <label for="seasonSelect">Season</label>
      <select id="seasonSelect" onchange="changeSeason(this.value)">
        <option value="">Loading...</option>
      </select>
    </div>

    <table id="league-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Name</th>
          <th>Games</th>
          <th>Win %</th>
          <th>Total Points</th>
          <th>Wins</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <div id="nextCompetition">
    Next Competition: <span id="nextCompetitionText">TBD</span>
    <div id="weather-widget" class="rounded-xl p-4 shadow-md text-center text-sm"
         style="max-width:600px;margin:0.75rem auto 0;background:var(--accent);color:var(--text);border-radius:14px;border:1px solid var(--border);">
    </div>
    <div id="weatherDetails">Loading weather...</div>
  </div>

  <div class="modal" id="scoreModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle" style="margin-top:0;"></h2>
      <div class="tabs">
        <button id="tabNet" onclick="showTab('net')" class="active">Scores</button>
        <button id="tabPositions" onclick="showTab('positions')">Competition History</button>
        <button id="tabHistory" onclick="showTab('history')">Results History</button>
      </div>
      <canvas id="scoreChart" height="200"></canvas>
      <canvas id="positionChart" height="200" style="display:none;"></canvas>
      <ul id="scoreList"></ul>
      <ul id="positionList" style="display:none;"></ul>
    </div>
  </div>

  <!-- ===================== APP LOGIC (ORIGINAL FEATURES RESTORED) ===================== -->
  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî State ‚Äî‚Äî‚Äî‚Äî‚Äî
    let history = [];
    let selectedYear = null;
    let currentSeason = null;

    // Robust date parser: handles Excel serial numbers, dd/mm/yyyy, text like "12 April 2026", and native Date strings
    function parseDateStr(value) {
      if (value === null || value === undefined || value === '') return null;

      // If the XLSX output gives a JavaScript Date already
      if (value instanceof Date && !isNaN(value)) return value;

      // Excel serial date (numbers)
      if (Number.isFinite(value)) {
        const excelEpoch = new Date(1899, 11, 30);
        return new Date(excelEpoch.getTime() + value * 86400000);
      }

      if (typeof value === 'string') {
        // dd/mm/yyyy or d/m/yyyy
        const slashMatch = value.match(/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})\s*$/);
        if (slashMatch) {
          const d = parseInt(slashMatch[1], 10);
          const m = parseInt(slashMatch[2], 10) - 1;
          let y = parseInt(slashMatch[3], 10);
          if (y < 100) y += 2000;
          return new Date(y, m, d);
        }

        // ISO or "12 Apr 2026"
        const tryDate = new Date(value);
        if (!isNaN(tryDate)) return tryDate;

        // Fallback: "12 April 2026"
        const parsed = Date.parse(value.replace(/(\d+)\s+([A-Za-z]+)\s+(\d{4})/, '$1 $2 $3'));
        if (!isNaN(parsed)) return new Date(parsed);
      }

      return null;
    }

    function getYearFromEntry(entry) {
      const date = parseDateStr(entry.Date);
      return date instanceof Date && !isNaN(date) ? date.getFullYear() : null;
    }

    // Populate season dropdown from history years
    // Default order:
    // 1) Current calendar year if present (fixes 2026 visibility)
    // 2) Current Season from Settings if present
    // 3) Latest year in data
    function populateSeasonDropdown(data) {
      const years = [...new Set(data.map(getYearFromEntry).filter(y => y))].sort((a, b) => b - a);
      const dropdown = document.getElementById('seasonSelect');

      if (!years.length) {
        dropdown.innerHTML = '<option value="">No seasons</option>';
        selectedYear = null;
        return;
      }

      dropdown.innerHTML = years.map(y => `<option value="${y}">${y} Season</option>`).join('');

      const thisYear = new Date().getFullYear();
      selectedYear =
        years.includes(thisYear) ? thisYear :
        (currentSeason && years.includes(currentSeason)) ? currentSeason :
        years[0];

      dropdown.value = selectedYear;
    }

    function changeSeason(year) {
      selectedYear = parseInt(year, 10);
      updateLeague(history);
    }

    // Fetch workbook from GitHub and initialize
    fetch("https://raw.githubusercontent.com/CMPtechnik/cheadlegolfacademy/main/data/leaguedata.xlsx?v=" + new Date().getTime())
      .then(res => res.arrayBuffer())
      .then(buffer => {
        const workbook = XLSX.read(buffer, { type: 'array' });

        // Read Settings sheet for Next Competition and Current Season
        const settingsSheet = workbook.Sheets['Settings'];
        if (settingsSheet) {
          const settingsData = XLSX.utils.sheet_to_json(settingsSheet, { header: 1 });
          let nextCompetitionVal, currentSeasonVal;

          settingsData.forEach(row => {
            if (!row[0]) return;
            const key = row[0].toString().toLowerCase().trim();
            if (key.includes('next competition')) nextCompetitionVal = row[1];
            if (key.includes('current season')) currentSeasonVal = parseInt(row[1], 10);
          });

          if (nextCompetitionVal) document.getElementById('nextCompetitionText').innerText = nextCompetitionVal;
          if (currentSeasonVal && !isNaN(currentSeasonVal)) currentSeason = currentSeasonVal;
        }

        // Read main sheet (first sheet) into history
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        history = XLSX.utils.sheet_to_json(sheet);

        // populate dropdown and render
        populateSeasonDropdown(history);

        // set last update text in info-bar if possible
        try {
          const lastCompetitionEntry = history.reduce((latest, entry) =>
            (parseDateStr(entry.Date) && parseDateStr(entry.Date) > parseDateStr(latest.Date)) ? entry : latest
          , history[0]);

          if (lastCompetitionEntry) {
            const lastCompetition = lastCompetitionEntry.Competition || '';
            const lastUpdateDate = parseDateStr(lastCompetitionEntry.Date);
            const lastUpdate = lastUpdateDate ? lastUpdateDate.toLocaleDateString() : '';
            const infoBar = document.querySelector(".info-bar h4");
            if (infoBar) {
              infoBar.innerHTML = `<span style="color:#ff2d55;font-weight:900;">Last Update - ${lastUpdate}</span> <span style="opacity:0.7;">|</span> Last Competition: ${escapeHtml(lastCompetition)}`;
            }
          }
        } catch (e) {
          // ignore
        }

        updateLeague(history);
      })
      .catch(err => {
        console.error("Error loading workbook:", err);
      });

    // Main stats computation ‚Äî filters by selectedYear
    function updateLeague(data) {
      const filtered = selectedYear ? data.filter(e => getYearFromEntry(e) === selectedYear) : data;
      const netScores = {}, netWins = {}, totalPoints = {}, rounds = {};

      filtered.forEach(entry => {
        const { Name, Score, Position, Points, Competition } = entry;
        const net = parseFloat(Score);
        if (isNaN(net)) return;

        netScores[Name] = netScores[Name] || [];
        rounds[Competition] = rounds[Competition] || [];

        netScores[Name].push(net);
        rounds[Competition].push({ name: Name, position: parseInt(Position, 10) });
        totalPoints[Name] = (totalPoints[Name] || 0) + (parseFloat(Points) || 0);
      });

      Object.values(rounds).forEach(players =>
        players.filter(p => p.position === 1).forEach(p =>
          netWins[p.name] = (netWins[p.name] || 0) + 1
        )
      );

      const players = Object.keys(netScores).map(name => {
        const games = netScores[name].length;
        const wins = netWins[name] || 0;
        const winPct = games ? ((wins / games) * 100).toFixed(1) : '0.0';
        return { name, games, winPct, points: totalPoints[name] || 0, trophies: wins };
      }).sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.trophies !== a.trophies) return b.trophies - a.trophies;
        if (parseFloat(b.winPct) !== parseFloat(a.winPct)) return parseFloat(b.winPct) - parseFloat(a.winPct);
        return a.name.localeCompare(b.name);
      });

      renderTable(players);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#league-table tbody");
      tbody.innerHTML = '';

      data.forEach((p, i) => {
        const won = history
          .filter(e => e.Name === p.name && parseInt(e.Position, 10) === 1 && getYearFromEntry(e) === selectedYear)
          .map(e => e.Competition)
          .filter(Boolean);

        const span = won.length
          ? `<span class="trophy" onclick="toggleTooltip(this)">
               ${'üèÜ'.repeat(won.length)}
               <span class="tooltip-bubble">${won.map(escapeHtml).join(', ')}</span>
             </span>`
          : '';

        tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td><a href="#" onclick="showPlayerModal('${escapeHtml(p.name)}'); return false;">${escapeHtml(p.name)}</a></td>
            <td>${p.games}</td>
            <td>${p.winPct}%</td>
            <td>${p.points}</td>
            <td>${span}</td>
          </tr>`;
      });
    }

    // small helper to avoid breaking quotes in names
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function toggleTooltip(el) {
      document.querySelectorAll('.trophy.show-tooltip').forEach(t => {
        if (t !== el) t.classList.remove('show-tooltip');
      });
      el.classList.toggle('show-tooltip');
    }

    document.addEventListener('click', e => {
      if (!e.target.closest('.trophy')) {
        document.querySelectorAll('.trophy.show-tooltip').forEach(t => t.classList.remove('show-tooltip'));
      }
    });

    function showPlayerModal(name) {
      const scores = history
        .filter(e => e.Name === name && getYearFromEntry(e) === selectedYear)
        .map(e => ({
          competition: e.Competition,
          score: parseFloat(e.Score),
          position: parseInt(e.Position, 10),
          points: parseFloat(e.Points) || 0,
          date: e.Date
        }))
        .filter(s => !isNaN(s.score) && s.competition)
        .sort((a, b) => (parseDateStr(a.date) || 0) - (parseDateStr(b.date) || 0));

      document.getElementById('modalTitle').innerText = `${name}'s Score History`;

      const scoreList = document.getElementById('scoreList');
      const posList = document.getElementById('positionList');
      scoreList.innerHTML = '';
      posList.innerHTML = '';

      scores.forEach(s => {
        const trophy = s.position === 1 ? ' üèÜ' : '';
        scoreList.innerHTML += `<li>${escapeHtml(s.competition)}: Gross ${s.score}, Position ${s.position}${trophy}</li>`;
        posList.innerHTML += `<li>${escapeHtml(s.competition)}: Finished ${s.position}, Points ${s.points}${trophy}</li>`;
      });

      const labels = scores.map(s => s.competition);
      const netData = scores.map(s => s.score);
      const posData = scores.map(s => s.position);

      const ctxNet = document.getElementById('scoreChart').getContext('2d');
      if (window.scoreChart instanceof Chart) window.scoreChart.destroy();
      window.scoreChart = new Chart(ctxNet, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Score', data: netData, fill: false, tension: 0.25 },
            { label: 'Par 64', data: new Array(labels.length).fill(64), borderDash: [6, 6], fill: false, tension: 0 },
            { label: 'Par 32', data: new Array(labels.length).fill(32), borderDash: [6, 6], fill: false, tension: 0 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      const ctxPos = document.getElementById('positionChart').getContext('2d');
      if (window.positionChart instanceof Chart) window.positionChart.destroy();
      window.positionChart = new Chart(ctxPos, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Finishing Position', data: posData, fill: false, tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              reverse: true,
              title: { display: true, text: 'Finishing Position' }
            }
          }
        }
      });

      showTab('net');
      document.getElementById('scoreModal').style.display = 'flex';
    }

    // Tabs:
    // net -> show score chart + score list
    // positions -> show position chart + position list
    // history -> show BOTH lists (no charts) so it behaves like a readable history screen
    function showTab(tab) {
      ['tabNet', 'tabPositions', 'tabHistory'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
      });

      const tabEl =
        tab === 'net' ? document.getElementById('tabNet') :
        tab === 'positions' ? document.getElementById('tabPositions') :
        document.getElementById('tabHistory');

      if (tabEl) tabEl.classList.add('active');

      const scoreList = document.getElementById('scoreList');
      const positionList = document.getElementById('positionList');
      const scoreChart = document.getElementById('scoreChart');
      const positionChart = document.getElementById('positionChart');

      if (tab === 'net') {
        scoreChart.style.display = 'block';
        positionChart.style.display = 'none';
        scoreList.style.display = 'block';
        positionList.style.display = 'none';
      } else if (tab === 'positions') {
        scoreChart.style.display = 'none';
        positionChart.style.display = 'block';
        scoreList.style.display = 'none';
        positionList.style.display = 'block';
      } else {
        scoreChart.style.display = 'none';
        positionChart.style.display = 'none';
        scoreList.style.display = 'block';
        positionList.style.display = 'block';
      }
    }

    function closeModal() {
      document.getElementById('scoreModal').style.display = 'none';
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }
  </script>

  <!-- ===================== WEATHER (ORIGINAL FEATURE RESTORED) ===================== -->
  <script>
    const WEATHER_API_KEY = "e583bd0c194bbfeb3deb92f6bfdad11a";
    const LOCATION = "Cheadle,UK";

    function extractDateFromText(text) {
      let date = null;

      const slashMatch = text.match(/\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/);
      if (slashMatch) {
        const [_, day, month, year] = slashMatch;
        date = new Date(`${year}-${month}-${day}`);
      } else {
        const wordMatch = text.match(/\b(\d{1,2})\s([A-Za-z]+)\s?(\d{4})?/);
        if (wordMatch) {
          const [_, day, monthName, yearPart] = wordMatch;
          const year = yearPart ? yearPart : new Date().getFullYear();
          date = new Date(`${day} ${monthName} ${year}`);
        }
      }
      return date;
    }

    function windDirection(degrees) {
      const dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
      return dirs[Math.round(degrees / 45) % 8];
    }

    function fetchWeatherForNextComp(nextCompText) {
      const compDate = extractDateFromText(nextCompText);
      if (!compDate) return;

      fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${LOCATION}&appid=${WEATHER_API_KEY}&units=metric`)
        .then(res => res.json())
        .then(data => {
          const forecasts = (data.list || []).filter(item => {
            const forecastDate = new Date(item.dt_txt);
            return forecastDate.getDate() === compDate.getDate() &&
                   forecastDate.getMonth() === compDate.getMonth() &&
                   forecastDate.getFullYear() === compDate.getFullYear();
          });

          let forecast = forecasts.find(f => f.dt_txt.includes('12:00:00')) ||
                         forecasts.find(f => f.dt_txt.includes('20:00:00')) ||
                         forecasts[0];

          const container = document.getElementById("weatherDetails");

          if (forecast && forecast.weather && forecast.weather[0]) {
            const iconUrl = `https://openweathermap.org/img/wn/${forecast.weather[0].icon}@4x.png`;
            const windSpeedMph = (forecast.wind.speed * 2.23694).toFixed(1);
            const windDir = windDirection(forecast.wind.deg);
            const arrowStyle = `transform: rotate(${forecast.wind.deg}deg); display:inline-block; transition:transform 0.3s`;

            container.innerHTML = `
              <img src="${iconUrl}" alt="${forecast.weather[0].description}" style="height:70px;filter:drop-shadow(0 0 3px rgba(0,0,0,0.35));">
              <div style="font-weight:900;">${forecast.weather[0].main} <span style="opacity:0.8;">(${forecast.weather[0].description})</span></div>
              <div>Temp: <strong>${Math.round(forecast.main.temp)}¬∞C</strong></div>
              <div>Wind: <strong>${windSpeedMph} mph</strong> (${windDir}) <span style="${arrowStyle}">‚¨ÜÔ∏è</span></div>
            `;
          } else {
            container.innerHTML = "<div>No forecast available yet for this date.</div>";
          }
        })
        .catch((err) => {
          console.error("Weather API error:", err);
          document.getElementById("weatherDetails").innerHTML = "<div>Unable to load weather.</div>";
        });
    }

    const nextCompEl = document.getElementById('nextCompetitionText');
    const observer = new MutationObserver(() => {
      if (nextCompEl.innerText && nextCompEl.innerText !== 'TBD') {
        fetchWeatherForNextComp(nextCompEl.innerText);
        observer.disconnect();
      }
    });

    observer.observe(nextCompEl, { childList: true, subtree: true });
  </script>

  <div class="info-bar">
    <h4><span style="color:#ff2d55;">Loading update...</span></h4>
  </div>

  <div class="footer">
    <div style="margin: 0.75rem 0;">
      <img src="logocja.png" alt="League Logo" style="height:64px;margin-right:10px;" />
      <img src="https://cheadlegolf.com/wp-content/uploads/2016/08/CGC-logo-HR-02.png" alt="CGC Logo" width="80" height="80"/>
    </div>
    <div style="font-weight:900;">Build v1.0.0 | Tables and Members</div>
    <div style="margin-top:0.35rem;">
      <a href="https://www.theapplegeek.co.uk" target="_blank" rel="noopener">The Apple Geek Data Solutions</a>
    </div>
  </div>

</body>
</html>
