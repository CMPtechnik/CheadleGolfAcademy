<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cheadle Juniors - Results History</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="favicon.png" sizes="180x180">
  <meta name="theme-color" content="#005c41" />
  <style>
    :root { --primary: #005c41; --accent: #e6f2ef; --text: #1e1e1e; --bg: #fdfdfd; --border: #ccc; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--primary); color: #fff; display: flex; flex-direction: column; align-items: center; padding: 1rem; }
    nav { margin-bottom: 0.5rem; display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
    nav a { color: #fff; text-decoration: none; margin: 0 0.5rem; font-size: 0.9rem; }
    h1 { margin: 0; font-size: 1.5rem; }
    main { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
    section { margin-bottom: 2rem; position: relative; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: center; }
    th { background: var(--accent); }
    .print-btn { position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.5rem 1rem; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .logo { display: none; }
    .print-domain { display: none; }

    /* Season filter styling */
    #seasonFilterContainer {
      text-align: center;
      margin: 1rem auto;
    }
    #seasonFilter {
      padding: 0.4rem 0.6rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    @media screen and (max-width:768px) {
      header { padding: 0.5rem; }
      nav a { display: inline-block; margin: 0 0.5rem; }
      h1 { margin-top: 0.5rem; }
      table { display: block; overflow-x: auto; }
    }

    @media print {
      body * { visibility: hidden !important; }
      .print-target, .print-target * { visibility: visible !important; }
      .print-target { position: static !important; width: auto !important; }
      .print-btn { display: none !important; }
      .logo { display: block !important; max-width: 300px; margin: 0 auto 0.5rem; }
      .print-domain { display: block !important; text-align: center; font-size: 0.9rem; margin-bottom: 1rem; }
      @page { size: auto; margin: 1cm; }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Home</a> |
      Results History
    </nav>
    <h1>Results History</h1>
    <br><center>‚¨ÖÔ∏è‚û°Ô∏è Scroll to view full table</center>
  </header>

  <!-- Season filter -->
  <div id="seasonFilterContainer">
    <label for="seasonFilter"><strong>Select Season:</strong> </label>
    <select id="seasonFilter"></select>
  </div>

  <main id="content">
    <!-- Competition sections injected here -->
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
function parseDateStr(s) {
  if (!s) return new Date('Invalid');

  // Excel serial number format (days since 1900)
  if (typeof s === 'number') {
    return new Date(Math.round((s - 25569) * 86400 * 1000));
  }

  // Text in dd/mm/yyyy or d/m/yyyy format
  if (typeof s === 'string' && s.includes('/')) {
    const parts = s.split('/');
    const d = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    const y = parseInt(parts[2], 10);
    if (!isNaN(d) && !isNaN(m) && !isNaN(y)) {
      return new Date(y, m - 1, d);
    }
  }

  // Fallback
  const parsed = new Date(s);
  return isNaN(parsed) ? new Date('Invalid') : parsed;
}


    let allCompetitions = [];
    let currentSeason = null;

    fetch('https://raw.githubusercontent.com/CMPtechnik/cheadlegolfacademy/main/data/leaguedata.xlsx?v=' + Date.now())
      .then(res => res.arrayBuffer())
      .then(buf => {
        const wb = XLSX.read(buf, { type: 'array' });

        // 1Ô∏è‚É£ Get current season from Settings
        const settings = wb.Sheets['Settings'];
        if (settings) {
          const settingsData = XLSX.utils.sheet_to_json(settings, { header: 1 });
          settingsData.forEach(row => {
            if (row[0] && row[0].toString().toLowerCase().includes('current season')) {
              currentSeason = row[1];
            }
          });
        }

        // 2Ô∏è‚É£ Read main results
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        // 3Ô∏è‚É£ Get all available years
        const years = Array.from(new Set(rows.map(r => parseDateStr(r.Date).getFullYear()))).sort((a,b)=>b-a);

        // Populate dropdown
        const dropdown = document.getElementById('seasonFilter');
        years.forEach(y => {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          dropdown.appendChild(opt);
        });

        // Default to current season or latest year
        if (currentSeason && years.includes(parseInt(currentSeason))) {
          dropdown.value = currentSeason;
        } else {
          dropdown.value = years[0];
          currentSeason = years[0];
        }

        allCompetitions = rows;
        renderSeason(currentSeason);

        dropdown.addEventListener('change', e => {
          renderSeason(e.target.value);
        });
      });

    function renderSeason(selectedYear) {
      const container = document.getElementById('content');
      container.innerHTML = '';

      const seasonData = allCompetitions.filter(r => parseDateStr(r.Date).getFullYear() == selectedYear);
      if (!seasonData.length) {
        container.innerHTML = `<p style="text-align:center;">No results found for ${selectedYear}.</p>`;
        return;
      }

      const hasSFcol = seasonData.length && seasonData[0].hasOwnProperty('Stableford Points');

      const groups = {};
      seasonData.forEach(r => {
        const key = r.Title || r.Competition || 'Unknown';
        if (!groups[key]) groups[key] = [];
        groups[key].push(r);
      });

      const comps = Object.keys(groups).map(key => {
        const recs = groups[key];
        const date = parseDateStr(recs[0].Date);
        return { title: key, date: date, records: recs };
      });

      comps.sort((a, b) => b.date - a.date);

      comps.forEach(c => {
        const isStable = c.title.toLowerCase().includes('stableford') && hasSFcol;
        const section = document.createElement('section');

        const logo = document.createElement('img');
        logo.src = 'logo.png';
        logo.alt = 'League Logo';
        logo.className = 'logo';
        section.appendChild(logo);

        const domain = document.createElement('div');
        domain.textContent = 'www.cheadlegolfacademy.co.uk';
        domain.className = 'print-domain';
        section.appendChild(domain);

        const header = document.createElement('h2');
        header.textContent = `${c.title} ‚Äî ${c.date.toLocaleDateString('en-GB')}`;
        section.appendChild(header);

        const printBtn = document.createElement('button');
        printBtn.textContent = 'Print PDF';
        printBtn.className = 'print-btn';
        printBtn.addEventListener('click', () => {
          document.querySelectorAll('.print-target').forEach(el => el.classList.remove('print-target'));
          section.classList.add('print-target');
          window.print();
        });
        section.appendChild(printBtn);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const cols = ['Competition', 'Position', 'Name', isStable ? 'Stableford' : 'Score', 'Points', 'Trophy'];
        thead.innerHTML = `<tr>${cols.map(col => `<th>${col}</th>`).join('')}</tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        c.records.sort((a, b) => parseInt(a.Position) - parseInt(b.Position));
        c.records.forEach(r => {
          const pos = parseInt(r.Position, 10);
          let trophy = '';
          if (pos === 1) trophy = 'üèÜ';
          else if (pos === 2) trophy = 'ü•à';
          else if (pos === 3) trophy = 'ü•â';
          const sf = isNaN(parseInt(r['Stableford Points'])) ? 0 : parseInt(r['Stableford Points']);
          const tdValues = [
            r.Competition || '',
            r.Position,
            r.Name || '',
            isStable ? sf : r.Score || '',
            r.Points || '',
            trophy
          ];
          const tr = document.createElement('tr');
          tr.innerHTML = tdValues.map(v => `<td>${v}</td>`).join('');
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        section.appendChild(table);
        container.appendChild(section);
      });
    }
  </script>
</body>
</html>
